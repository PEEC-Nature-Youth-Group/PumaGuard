name: pumaguard
icon: pumaguard-logo.png
base: core22 # We need Python <= 3.10
adopt-info: pumaguard
license: Apache-2.0
grade: stable
confinement: strict

summary: PumaGuard is a machine-learning based Puma mitigation solution
description: |
  The goal of this project is to accurately classify images based on the
  presence of mountain lions. This can have applications in wildlife
  monitoring, research, and conservation efforts. The model is trained on a
  labeled dataset and validated using a separate set of images.

environment:
  TF_CPP_MIN_LOG_LEVEL: 3  # or any {'0', '1', '2'}
  TF_ENABLE_ONEDNN_OPTS: 0
  PUMAGUARD_MODEL_PATH: $SNAP/models

apps:
  pumaguard-server:
    command: bin/snapcraft-preload $SNAP/bin/python3 $SNAP/bin/pumaguard-server
    completer: bin/server-bash-completions.sh
    plugs:
      - home
      - network
  pumaguard-classify:
    command: bin/snapcraft-preload $SNAP/bin/python3 $SNAP/bin/pumaguard-classify
    completer: bin/classify-bash-completions.sh
    plugs:
      - home
      - network
  pumaguard-train:
    command: bin/snapcraft-preload $SNAP/bin/python3 $SNAP/bin/pumaguard-train
    plugs:
      - home
      - network
  vsftpd:
    command: usr/sbin/vsftpd $SNAP/etc/vsftpd.conf
    daemon: simple
    plugs:
      - network-bind

parts:
  snapcraft-preload:
    source: https://github.com/sergiusens/snapcraft-preload.git
    plugin: cmake
    cmake-parameters:
      - -DCMAKE_INSTALL_PREFIX=/
    build-packages:
      - on amd64:
          - gcc-multilib
          - g++-multilib
  pumaguard:
    plugin: python
    source: .
    build-packages:
      - git
      - python3-pip
    override-build: |
      VERSION=$(git describe --tags | sed --regexp-extended 's/^v([0-9]+)(-([0-9]+))?.*/\1.post\3/; s/.post$//')
      craftctl set version="v${VERSION}"
      pip install poetry
      poetry version "${VERSION}"
      craftctl default
      cp --recursive models ${CRAFT_PART_INSTALL}/models
      for script in classify train server; do
        install --mode 0755 pumaguard/completions/pumaguard-${script}-completions.sh ${CRAFT_PART_INSTALL}/bin/${script}-bash-completions.sh
      done
    stage-packages:
      - inotify-tools

  ftp:
    plugin: nil
    override-build: |
      craftctl default
      cat <<EOF > vsftpd.conf
      chroot_local_user=YES
      listen=YES
      listen_ipv6=YES
      EOF
      install --mode 0644 vsftpd.conf ${CRAFT_PART_INSTALL}/etc/vsftpd.conf
    stage-packages:
      - vsftpd
